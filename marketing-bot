import os
import sqlite3
import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# --- DATABASE SETUP ---
def init_db():
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users 
                 (user_id INTEGER PRIMARY KEY, questions_asked INTEGER, next_reset TEXT)''')
    conn.commit()
    conn.close()

def get_user_data(user_id):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    c.execute("SELECT questions_asked, next_reset FROM users WHERE user_id=?", (user_id,))
    row = c.fetchone()
    conn.close()
    if row:
        return {"count": row[0], "reset": row[1]}
    return {"count": 0, "reset": None}

def update_user_data(user_id, count, reset_date=None):
    conn = sqlite3.connect('bot_data.db')
    c = conn.cursor()
    if reset_date:
        c.execute("INSERT OR REPLACE INTO users (user_id, questions_asked, next_reset) VALUES (?, ?, ?)",
                  (user_id, count, reset_date.isoformat()))
    else:
        c.execute("UPDATE users SET questions_asked=? WHERE user_id=?", (count, user_id))
        if c.rowcount == 0:
            c.execute("INSERT INTO users (user_id, questions_asked) VALUES (?, ?)", (user_id, count))
    conn.commit()
    conn.close()

# --- BOT LOGIC ---
MARKETING_QA = [
    {"q": "What is SEO?", "a": "Search Engine Optimization - the process of improving your site to increase visibility for relevant searches."},
    {"q": "What is CTR?", "a": "Click-Through Rate - the percentage of people who see your ad and click it."},
    {"q": "What is PPC?", "a": "Pay-Per-Click - an internet advertising model used to drive traffic to websites."},
    {"q": "What is a Lead?", "a": "A person who has indicated interest in your company's product or service."},
    {"q": "What is ROI?", "a": "Return on Investment - a measure used to evaluate the efficiency of an investment."}
]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Welcome to the Digital Marketing Challenge! Ask me any marketing question. You have 5 questions per week.")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_text = update.message.text.lower()
    data = get_user_data(user_id)
    
    # Check if user is locked out
    if data["reset"]:
        reset_time = datetime.datetime.fromisoformat(data["reset"])
        if datetime.datetime.now() < reset_time:
            days_left = (reset_time - datetime.datetime.now()).days
            await update.message.reply_text(f"Challenge completed! Please come back in {days_left} days for your next set of questions.")
            return
        else:
            # Time to reset
            update_user_data(user_id, 0, None)
            data["count"] = 0

    # Logic for answering (Simple keyword match for demo)
    response = "I'm not sure about that. Try asking about SEO, CTR, PPC, Lead, or ROI!"
    for item in MARKETING_QA:
        if item["q"].lower().replace("?", "") in user_text:
            response = item["a"]
            break

    # Update count
    new_count = data["count"] + 1
    if new_count >= 5:
        next_week = datetime.datetime.now() + datetime.timedelta(days=7)
        update_user_data(user_id, new_count, next_week)
        await update.message.reply_text(f"{response}\n\nâœ… That was your 5th question! You've finished this week's challenge. See you next week!")
    else:
        update_user_data(user_id, new_count)
        await update.message.reply_text(f"{response}\n\n({new_count}/5 questions used)")

if __name__ == '__main__':
    TOKEN = os.getenv("BOT_TOKEN")
    if not TOKEN:
        print("Error: No BOT_TOKEN found in environment variables.")
    else:
        init_db()
        app = Application.builder().token(TOKEN).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        print("Bot is running...")
        app.run_polling()
